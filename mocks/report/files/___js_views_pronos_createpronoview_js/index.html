<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>..\js\views\pronos\createpronoview.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"></i></a></h2>
      <p class="stat">64.48</p>
    </div>
    <div class="span6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h2>
      <p class="stat">226</p>
    </div>
  </div>
  <div class="row historical">
    <div class="span6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="span6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="span6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty"></i></a></h2>
      <p class="stat">38.13</p>
    </div>
    <div class="span6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs"></i></a></h2>
      <p class="stat">2.35</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">define(['jquery', 'underscore', 'backbone',
        'fmk/templateengine', 'fmk/lotofootapi', 'fmk/alertview', 'fmk/urls',
        'views/teams/pickTeamView',
        'i18n!tmpl/pronos/nls/createprono', 'i18n!nls/country', 'text!tmpl/pronos/createprono.html'],
function($, _, Backbone, te, LotofootApi, AlertView, urls, PickTeamView, i18n, country, tmpl) {

    var ClassView = Backbone.View.extend({
        el : $('#container'),
        initialize : function() {
            this.user = this.options.user;
            this.alertView = new AlertView();
            
            this.gameType = null; // variable for the type of the game : league, cup, international, etc.
            this.teams = []; // Array with the two teams for the game
            this.games = []; // Array with the created games
            this.clubs = {}; // List of all the clubs
            this.international = {}; // list of international teams
            
            // Bind functions to the view
            // By default, they bind to the window because they are function callbacks 
            this.successGetTeamsCallback = _.bind(this.successGetTeams, this);
        },
        render : function() {
            var self = this;
            
            LotofootApi.getTeams({}, this.successGetTeamsCallback, function(msg){// error
                console.log(msg); // TODO : manage errors
            });
        },
        /*
         * Success of getTeams WS
         */
        successGetTeams : function(msg){
            this.clubs = msg.clubs;
            this.international = msg.international;
            var clubsList = [];

            _.each(msg.clubs, function(item){ // fetch the right name of the country
                item.name = country[item.id];
                clubsList.push(item);
            });

            _.each(msg.international, function(item){ // Function for the multi-lingual, the database is in French
                item.name = country[item.country];
            });
            
            // Rendering the view
            $(this.el).html(te.renderTemplate(tmpl, {
                i18n : i18n,
                urls : urls
            }));
            
            this.pickTeamView = new PickTeamView({
                el : this.$('#pickTeam'),
                clubs : clubsList,
                international : this.international
            });

            this.pickTeamView.render();
            
            this.fillSelectElements();
        },
        /*
         * Events of the view
         */
        events : {
            "click #SelectGame a" : "kindOfGame",
            "click #Clubs a.country" : "selectCountry",
            "click a.club" : "pickATeam",
            "click a.international" : "pickANationalTeam",
            "click button.remove-prono" : "removeProno"
        },
        kindOfGame : function(e){ // Pick the type of the game to bet
            e.preventDefault();
            this.gameType = this.$(e.currentTarget).attr('ref');
            
            this.$("#SelectGame").addClass('hide');
            // Display the right list in terms of the choice
            if(this.gameType == i18n.ref_international_game){
                this.$('#International').removeClass('hide');
            }else{
                this.$('#Clubs').removeClass('hide');
            }
        },
        selectCountry : function(e){ // Pick the country where the clubs are from
            e.preventDefault();
            var ref = this.$(e.currentTarget).attr('ref');
            var $selectedCountry = this.$(e.currentTarget).parent();
            $selectedCountry.removeClass('span3').addClass('span12');
            
            var $listCountry = this.$("#Clubs > div.span3");
            $listCountry.addClass('hide'); // Hide the other country
            
            $selectedCountry.find('div.row.hide').removeClass('hide');
        },
        pickATeam : function(e){ // Pick a team
            e.preventDefault();
            
            if(this.teams.length >= 2){ // A game cannot have more than two teams !
                return false;
            }
            
            /* Initialize variables */
            var $element = this.$(e.currentTarget);
            var ref = $element.attr('ref');
            var country = $element.attr('data-country');
            var $selectedCountry = $element.parents('div.span12');
            var $listCountry = this.$("#Clubs > div.span3");
            var team = this.getTeamInfos(ref,country);
            
            if(this.gameType == i18n.ref_league_game || this.gameType == i18n.ref_cup_game){
                this.teams.push(team);
            }
            else if(this.gameType == i18n.ref_europa_game){
                this.teams.push(team);
                $selectedCountry.find('div.row').addClass('hide');
                $selectedCountry.removeClass('span12').addClass('span3');
                $listCountry.removeClass('hide');
            }
            else{
                // TODO : Display errors
            }
            
            $element.parent().addClass('hide');
            this.addAGame();
        },
        pickANationalTeam : function(e){
            e.preventDefault();
            
            if(this.teams.length >= 2){ // A game cannot have more than two teams !
                return false;
            }
            
            var ref = this.$(e.currentTarget).attr('ref');
            var nation = {};
            
            _.every(this.international,function(item){
                if(item.id == ref){
                    nation = item;
                    return false;
                }
                return true;
            });
            
            if(this.gameType == i18n.ref_international_game){
                this.teams.push(nation);
            }else{
                // TODO : Display errors
            }
            
            this.$(e.currentTarget).parent().addClass('hide');
            this.addAGame();
        },
        removeProno : function(e){
            var role = $(e.currentTarget).attr('data-role');
            
            if(role == 'remove'){ // remove tr element linked to this
                $(e.currentTarget).parent().parent().remove();
            }  
        },
        /*
         * Tools functions
         */
        getTeamInfos : function(id,country){ // return the all the infos of the team in an object
            var team = {};
            var array = this.clubs[country].recs;
            
            _.every(array,function(club){
                if(club.id == id){
                    team = club;
                    return false;
                }
                return true;
            });
            
            return team;
        },
        fillSelectElements : function(){ // fill the two select elements to pick the schedule of the game
            var hoursOptions = "";
            var minutesOptions = "";
            
            for(var i = 0; i < 24; i++){
                hoursOptions += '<option value="' + i + '">' + i + '</option>';
            }
            this.$('#hourSchedule').html(hoursOptions);
            
            for(var i = 0; i < 60; i = i+15){
                minutesOptions += '<option value="' + i + '">' + i + '</option>';
            }
            this.$('#minuteSchedule').html(minutesOptions);
        },
        addAGame : function(){ // Append the game to the table
            if(this.teams.length == 0){ // Cannot create a game without team
                return false;
            }
            
            var game = this.teams[0].name;
            var element = this.$('div.games tr').first();
            var index = -1;

            if(this.teams.length == 2){
                game += ' - ' + this.teams[1].name;
                this.games.push(this.teams);
                index = this.games.length - 1;
                this.teams = []; // Empty array, the game was added
                if(this.pickTeamView){
                    this.pickTeamView.render();
                }
                
            }else if(this.teams.length == 1){
                this.$('div.games tbody').append(element[0].outerHTML);
            }
            
            this.$('div.games').removeClass('hide');
            // Update the game with the team (1 or 2)
            // Select the last td in the last tr (game created)
            var $tr = this.$('div.games tr').last();
            $tr.find('td').last().html(game);
            $tr.removeClass('hide');
            $tr.attr('ref',index);
        }
    });

    // Our module now returns our view
    return ClassView;
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
